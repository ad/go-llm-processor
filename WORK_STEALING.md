# Work Stealing в Processor

## Описание

Work-stealing - это механизм балансировки нагрузки, который позволяет процессорам с низкой загрузкой "воровать" задачи у перегруженных процессоров. Это повышает общую эффективность системы и предотвращает простои.

## Конфигурация

Work-stealing настраивается через переменные окружения:

```bash
# Включить/выключить work-stealing (по умолчанию true)
WORK_STEALING_ENABLED=true

# Интервал между попытками воровства задач (по умолчанию 120s)
WORK_STEALING_INTERVAL=120s

# Максимальное количество задач для воровства за один раз (по умолчанию 2)
WORK_STEALING_MAX_COUNT=2

# Минимальная свободная емкость для воровства (по умолчанию 0.3)
# Processor будет воровать задачи только если свободная емкость >= этого значения
WORK_STEALING_MIN_CAPACITY=0.3
```

## Алгоритм работы

1. **Периодическая проверка**: Каждые `WORK_STEALING_INTERVAL` processor проверяет свою загрузку
2. **Оценка емкости**: Вычисляется свободная емкость как `availableSlots / workerCount`
3. **Условие воровства**: Если емкость >= `WORK_STEALING_MIN_CAPACITY`, делается попытка воровства
4. **Запрос к manager**: Отправляется POST запрос на `/api/internal/work-steal`
5. **Обработка результата**: Полученные задачи добавляются в worker pool

## API взаимодействие

Processor отправляет запрос в manager:

```json
POST /api/internal/work-steal
Content-Type: application/json

{
  "processor_id": "proc-abc123",
  "max_steal_count": 2,
  "timeout_ms": 30000
}
```

Manager возвращает задачи от перегруженных процессоров:

```json
{
  "tasks": [
    {
      "id": "task1",
      "product_data": "...",
      "priority": 1,
      "retry_count": 0,
      "ollama_params": "..."
    }
  ]
}
```

## Логика manager

Manager ищет задачи для воровства по следующим критериям:

1. Задачи со статусом `processing`
2. Задачи, заблокированные более 60 секунд (heartbeat timeout)
3. Задачи от процессоров с высокой загрузкой
4. Исключает задачи от текущего processor

## Безопасность

- **Таймауты**: Все операции имеют таймауты для предотвращения блокировок
- **Освобождение задач**: При ошибках задачи автоматически освобождаются
- **Контекст отмены**: При отмене контекста все задачи возвращаются в пул
- **Ограничения**: Максимальное количество воруемых задач ограничено

## Мониторинг

Work-stealing активность можно отслеживать в логах:

```
Successfully stole 2 tasks from overloaded processors
Error during work stealing: connection timeout
Worker pool full, releasing stolen task task123
```

## Оптимизация производительности

- **Адаптивные интервалы**: Частота воровства подстраивается под текущую загрузку
- **Минимальная емкость**: Предотвращает воровство при высокой собственной загрузке
- **Батчинг**: Несколько задач воруются за один запрос
- **Неблокирующие операции**: Work-stealing не блокирует основной polling loop
